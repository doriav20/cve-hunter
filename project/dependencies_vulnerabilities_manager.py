from abc import ABC, abstractmethod
from time import sleep
from typing import Optional

import requests as requests

from dependency import Dependency, DependencyVulnerability
from utils import sort_by_version


class DependenciesVulnerabilitiesManager(ABC):
    """Abstract class for listing vulnerabilities of dependencies."""

    dependencies: list[Dependency]

    def __init__(self, dependencies: list[Dependency]) -> None:
        self.dependencies = dependencies

    @abstractmethod
    def _request_vulnerabilities_from_api_for_dependency(self, dependency: Dependency) -> dict:
        """Perform api call(s) to retrieve data about a given dependency."""
        pass

    @abstractmethod
    def get_vulnerabilities_for_dependency(self, dependency: Dependency) -> list[DependencyVulnerability]:
        """Return vulnerabilities of a specific dependency."""
        pass

    def get_all_vulnerabilities(self) -> list[DependencyVulnerability]:
        """Return a flattened list of all vulnerabilities of all class's dependencies."""
        deps_vulns = []

        for dep in self.dependencies:
            deps_vulns.extend(self.get_vulnerabilities_for_dependency(dep))

        return deps_vulns

    def get_fix_version(self, dependency_version: str, fixed_versions: list[str]) -> str:
        """
        Return closest fix version of a vulnerability.

        Parameters
        ----------
        dependency_version : str
            Current dependency version.
        fixed_versions : list[str]
            List of versions without a specific vulnerability.

        Returns
        -------
        str
            Closest version from fixed_versions to dependency_version.
        """
        versions = fixed_versions + [dependency_version]
        versions = sort_by_version(versions)
        closest_version_index = versions.index(dependency_version) + 1
        if closest_version_index == len(versions):
            return "No fix"
        return versions[closest_version_index]


class PythonDependenciesVulnerabilitiesManager(DependenciesVulnerabilitiesManager):
    """Class for listing vulnerabilities of python dependencies."""

    def _request_vulnerabilities_from_api_for_dependency(self, dependency: Dependency) -> Optional[dict]:
        """Perform an api call to my database and get data about a given dependency."""
        url = f'https://pypi.org/pypi/{dependency.name}/{dependency.version}/json'
        response = requests.get(url)
        if response.status_code != 200:
            return None

        data = response.json()
        return data

    def get_vulnerabilities_for_dependency(self, dependency: Dependency) -> list[DependencyVulnerability]:
        """Processing data from pypi and create DependencyVulnerability objects."""
        data = self._request_vulnerabilities_from_api_for_dependency(dependency)
        if data is None:
            return []

        dependency_vulnerabilities = []

        for vuln in data.get('vulnerabilities', []):
            cve_id = next(filter(lambda alias: alias.lower().startswith('cve'), vuln['aliases']), 'No cve found')
            fix_version = self.get_fix_version(dependency.version, vuln.get('fixed_in', []))

            dependency_vulnerabilities.append(
                DependencyVulnerability(dependency=dependency, fix_version=fix_version, cve_id=cve_id)
            )

        return dependency_vulnerabilities


class NpmDependenciesVulnerabilitiesManager(DependenciesVulnerabilitiesManager):
    """Class for listing vulnerabilities of npm dependencies."""

    def _get_cpe_name_for_dependency(self, dependency: Dependency) -> Optional[str]:
        """
        Return (incomplete) name of cpe.

        Perform an api call to nvd to get the prefix of cpe name. Actually, this method helps to in find the vendor in cpe name.

        Examples
        --------
        If dependency is lodash 4.17.5, the method returns `cpe:2.3:a:lodash:lodash:4.17.5`"
        """

        url = f'https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch={dependency.name}&resultsPerPage=1'
        response = requests.get(url)

        # Note that without the api key, nvd api is limited to 5 calls per 30 seconds, so sleep 30 seconds.
        # If the api key is used, the api will be limited to 50 calls per 30 seconds.
        if response.status_code == 403:
            sleep(30)
            response = requests.get(url)

        if response.status_code != 200:
            return None

        data = response.json()

        # Choose one vulnerability (no matter which one) to get cpe (cpe prefix is same for all vulnerabilities).
        if not data['vulnerabilities'] or not data['vulnerabilities'][0]['cve']['configurations']:
            return None

        # First configuration is related directly to the package.
        configuration = data['vulnerabilities'][0]['cve']['configurations'][0]

        cpe_names = list(map(lambda cpe: cpe['criteria'], configuration['nodes'][0]['cpeMatch']))

        if not cpe_names:
            return None

        # Delete suffix of cpe name, and concatenate formatted version.
        # If version is not in format of x.y.z, adding 0's.
        cpe_name = ':'.join(cpe_names[0].split(':')[:5])
        formatted_version = dependency.version
        if formatted_version.count('.') == 1:
            formatted_version += '.0'
        elif formatted_version.count('.') == 0:
            formatted_version += '.0.0'

        # Cpe name with version ends with .0, is represented with `:-`.
        if formatted_version.endswith('.0'):
            formatted_version = formatted_version[:-2] + ':-'

        return f'{cpe_name}:{formatted_version}'

    def _request_vulnerabilities_from_api_for_dependency(self, dependency: Dependency) -> Optional[dict]:
        """Use nvd to perform api call and search vulnerabilities by dependency cpe name."""
        cpe_name = self._get_cpe_name_for_dependency(dependency)
        if cpe_name is None:
            return None

        url = f'https://services.nvd.nist.gov/rest/json/cves/2.0?cpeName={cpe_name}&resultsPerPage=1000'
        response = requests.get(url)

        # Note that without the api key, nvd api is limited to 5 calls per 30 seconds, so sleep 30 seconds.
        # If the api key is used, the api will be limited to 50 calls per 30 seconds.
        if response.status_code == 403:
            sleep(30)
            response = requests.get(url)

        if response.status_code != 200:
            return None

        data = response.json()

        return data

    def get_vulnerabilities_for_dependency(self, dependency: Dependency) -> list[DependencyVulnerability]:
        """Processing data from nvd and create DependencyVulnerability objects."""

        def extract_versions_from_configuration(configuration: dict) -> list[str]:
            """Return fix versions from each cpe match record."""
            versions = []
            for node in configuration['nodes']:
                for cpe_match in node['cpeMatch']:
                    if fix_version := cpe_match.get('versionEndExcluding'):
                        versions.append(fix_version)
            return versions

        data = self._request_vulnerabilities_from_api_for_dependency(dependency)
        if data is None:
            return []

        dependency_vulnerabilities = []
        for vuln in data.get('vulnerabilities', []):
            cve_id = vuln['cve']['id']
            versions = extract_versions_from_configuration(vuln['cve']['configurations'][0])
            fix_version = self.get_fix_version(dependency.version, versions)

            dependency_vulnerabilities.append(
                DependencyVulnerability(dependency=dependency, fix_version=fix_version, cve_id=cve_id)
            )
        return dependency_vulnerabilities
