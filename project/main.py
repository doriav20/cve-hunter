import argparse
import os.path
import sys

from dependencies_parser import PythonDependenciesParser, NpmDependenciesParser
from dependencies_vulnerabilities_manager import (
    PythonDependenciesVulnerabilitiesManager,
    NpmDependenciesVulnerabilitiesManager,
)


def main():
    argument_parser = argparse.ArgumentParser()

    # Enable add_mutually_exclusive_group to force users to choose exactly one of the options.
    group = argument_parser.add_mutually_exclusive_group(required=True)
    group.add_argument('-r', metavar='path', type=str, help='Python requirements.txt file path')
    group.add_argument('-p', metavar='path', type=str, help='Npm package.json file path')

    args = argument_parser.parse_args()

    if path := args.r:
        dependencies_parser = PythonDependenciesParser(os.path.expanduser(path))
        dependencies_vulnerabilities_manager_class = PythonDependenciesVulnerabilitiesManager
    elif path := args.p:
        dependencies_parser = NpmDependenciesParser(os.path.expanduser(path))
        dependencies_vulnerabilities_manager_class = NpmDependenciesVulnerabilitiesManager
    else:
        # Should not happen, but if it is so prints error message and exit with error code 1
        print('There is not requirements.txt file nor package.json file', file=sys.stderr)
        exit(1)

    dependencies = dependencies_parser.get_dependencies()

    dependencies_vulnerabilities_manager = dependencies_vulnerabilities_manager_class(dependencies)

    vulnerabilities = dependencies_vulnerabilities_manager.get_all_vulnerabilities()

    # Print all vulnerabilities as a table
    print(f'{"Name":<50} {"Version":<15} {"CVE ID":<20} {"Fix Version":<15}')
    print(f'{"----":<50} {"-------":<15} {"------":<20} {"-----------":<15}')

    vulnerabilities = list(set(vulnerabilities))  # Avoid duplicates

    for vuln in vulnerabilities:
        print(f'{vuln.dependency.name:<50} {vuln.dependency.version:<15} {vuln.cve_id:<20} {vuln.fix_version:<15}')


if __name__ == '__main__':
    main()
