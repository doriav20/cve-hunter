import json
import os.path
import re
from abc import ABC, abstractmethod

from dependency import Dependency


class DependenciesParser(ABC):
    """Abstract class for parsing dependencies from requirements file."""

    requirements_path: str

    def __init__(self, requirements_path: str) -> None:
        assert os.path.isfile(requirements_path)
        self.requirements_path = requirements_path

    @abstractmethod
    def get_dependencies(self) -> list[Dependency]:
        """Abstract method that returns all dependencies as a list from requirements file."""
        pass


class PythonDependenciesParser(DependenciesParser):
    """Class for parsing dependencies from requirements.txt file."""

    def __init__(self, requirements_path: str) -> None:
        assert requirements_path.endswith('requirements.txt')
        super().__init__(requirements_path)

    def _parse_raw_dependency(self, raw_dependency: str) -> Dependency:
        """Split each line to name and version and create a dependency object."""
        self._validate_raw_dependency_format(raw_dependency)

        name, version = raw_dependency.split('==')
        name = name.strip().lower()
        version = version.strip()

        return Dependency(name=name, version=version)

    def _validate_raw_dependency_format(self, raw_dependency: str) -> None:
        """Use regex to validate that line is in format of {name}=={version}."""
        assert re.match('^[a-zA-Z0-9\-_]+\s*==\s*[0-9]+(\.[0-9]+)*$', raw_dependency)

    def get_dependencies(self) -> list[Dependency]:
        """Return all dependencies as a list from requirements.txt file."""
        with open(self.requirements_path, mode='r') as file:
            raw_dependencies = file.readlines()

        dependencies = []
        for rd in raw_dependencies:
            dependencies.append(self._parse_raw_dependency(rd))
        return dependencies


class NpmDependenciesParser(DependenciesParser):
    """Class for parsing dependencies from package.json file."""

    def __init__(self, requirements_path: str) -> None:
        assert requirements_path.endswith('package.json')
        super().__init__(requirements_path)

    def get_dependencies(self) -> list[Dependency]:
        """
        Return all dependencies as a list from package.json file.

        Check for packages in dependencies section and in devDependencies section.
        """
        with open(self.requirements_path, mode='r') as file:
            package_json = json.load(file)

        dependencies = []
        for name, version in package_json.get('dependencies', {}).items():
            dependencies.append(Dependency(name=name.lower(), version=version))

        for name, version in package_json.get('devDependencies', {}).items():
            dependencies.append(Dependency(name=name.lower(), version=version))

        return dependencies
